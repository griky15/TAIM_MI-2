<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leap Motion Simulator - Gestural Instrument</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            /* Fundo verde ciano suave */
            background: #A8E6CF;
            height: 100vh;
            display: flex;
            flex-direction: column;
            /* Texto escuro para contraste */
            color: #222;
            overflow: hidden;
        }

        .header {
            padding: 20px;
            background: rgba(255,255,255,0.4);
            text-align: center;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .controls {
            padding: 15px;
            background: rgba(255,255,255,0.3);
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .control-group label {
            font-size: 12px;
            opacity: 0.9;
        }

        select, button {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
            background: rgba(255,255,255,0.9);
            transition: all 0.2s ease;
        }

        button {
            background: #4CAF50;
            color: white;
            font-weight: bold;
        }

        button:hover {
            background: #45a049;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .main-area {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        #canvas {
            width: 100%;
            height: 100%;
            cursor: crosshair;
        }

        .info-overlay {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255,255,255,0.5);
            padding: 15px;
            border-radius: 10px;
            font-family: monospace;
            font-size: 14px;
            line-height: 1.6;
            pointer-events: none;
        }

        .info-overlay div {
            margin: 5px 0;
        }

        .rhythm-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.5);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            pointer-events: none;
        }

        .beat-dots {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .beat-dot {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            transition: all 0.1s ease;
        }

        .beat-dot.active {
            background: #4CAF50;
            box-shadow: 0 0 20px #4CAF50;
            transform: scale(1.3);
        }

        .instructions {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255,255,255,0.5);
            padding: 15px 30px;
            border-radius: 10px;
            text-align: center;
            font-size: 14px;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .instructions.show {
            display: block;
            opacity: 1;
        }

        .info-button {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: rgba(255,255,255,0.5);
            color: #222;
            border: 2px solid rgba(255,255,255,0.3);
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 100;
        }

        .info-button:hover {
            background: rgba(255,255,255,0.8);
            border-color: rgba(255,255,255,0.6);
            transform: scale(1.1);
        }

        .visual-indicator {
            position: absolute;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255,255,255,0.8) 0%, rgba(255,255,255,0.1) 70%);
            pointer-events: none;
            transition: all 0.1s ease;
            box-shadow: 0 0 30px rgba(255,255,255,0.5);
        }

        .note-label {
            position: absolute;
            background: rgba(255,255,255,0.6);
            color: #4CAF50;
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: bold;
            font-size: 18px;
            pointer-events: none;
            transform: translate(-50%, -50%);
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üéµGestural Instrument Simulator</h1>

    </div>

    <div class="controls">
        <div class="control-group">
            <label>Musical Scale:</label>
            <select id="scaleSelect">
                <option value="major">C Major</option>
                <option value="minor">C Minor</option>
                <option value="pentatonic">Pentatonic</option>
                <option value="blues">Blues</option>
                <option value="chromatic">Chromatic</option>
            </select>
        </div>

        <div class="control-group">
            <label>Instrument:</label>
            <select id="instrumentSelect">
                <option value="sine">Synth</option>
                <option value="guitar">Guitar</option>
                <option value="saxophone">Saxophone</option>
                <option value="piano">Piano</option>
            </select>
        </div>

        <div class="control-group">
            <label>Control:</label>
            <button id="startButton">‚ñ∂ Start Audio</button>
        </div>
    </div>

    <div class="main-area">
        <canvas id="canvas"></canvas>
        
        <div class="info-overlay">
            <div><strong>üìä Real-Time Parameters:</strong></div>
            <div>X Axis (Horizontal): <span id="xValue">0</span> ‚Üí Note: <span id="noteValue">-</span></div>
            <div>Y Axis (Vertical): <span id="yValue">0</span> ‚Üí Subdivision: <span id="rhythmValue">-</span></div>
            <div>Z Axis (Depth): <span id="zValue">50</span>% ‚Üí Volume: <span id="volumeValue">-</span></div>
            <div>Scale: <span id="scaleValue">C Major</span></div>
            <div>BPM: <span id="bpmValue">120</span></div>
        </div>

        <div class="rhythm-indicator">
            <div><strong>ü•Å Active Rhythm</strong></div>
            <div id="rhythmText" style="font-size: 20px; margin: 10px 0;">1/4</div>
            <div class="beat-dots" id="beatDots">
                <div class="beat-dot"></div>
                <div class="beat-dot"></div>
                <div class="beat-dot"></div>
                <div class="beat-dot"></div>
            </div>
        </div>

        <button class="info-button" id="infoButton">i</button>

        <div class="instructions" id="instructions">
            <strong>üéÆ Simulated Control:</strong><br>
            <strong>X Axis (Horizontal):</strong> MouseX changes the note<br>
            <strong>Y Axis (Vertical):</strong> MouseY controls note speed<br>
            <strong>Z Axis (Depth):</strong> Mouse wheel üñ±Ô∏è controls volume<br>
            <strong>Scales:</strong> Keys 1-5 (1=Major, 2=Minor, 3=Pentatonic, 4=Blues, 5=Chromatic)<br>
            <strong>Instruments:</strong> Arrows ‚Üê ‚Üí (Synth ‚Üí Guitar ‚Üí Saxophone ‚Üí Piano)<br>
            <strong>BPM:</strong> Arrows ‚Üë ‚Üì (¬±5 BPM)
        </div>
    </div>

    <script>
        // Info button toggle
        const infoButton = document.getElementById('infoButton');
        const instructions = document.getElementById('instructions');
        
        infoButton.addEventListener('click', function() {
            instructions.classList.toggle('show');
        });

        // Web Audio API Setup
        let audioContext;
        let isPlaying = false;
        let currentFrequency = 440;
        let targetFrequency = 440;

        // Canvas Setup
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        
        function resizeCanvas() {
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        // Musical Scales (frequencies in Hz for notes C3 to C5)
        const scales = {
            major: [130.81, 146.83, 164.81, 174.61, 196.00, 220.00, 246.94, 261.63, 293.66, 329.63, 349.23, 392.00, 440.00, 493.88, 523.25],
            minor: [130.81, 146.83, 155.56, 174.61, 196.00, 207.65, 233.08, 261.63, 293.66, 311.13, 349.23, 392.00, 415.30, 466.16, 523.25],
            pentatonic: [130.81, 146.83, 164.81, 196.00, 220.00, 261.63, 293.66, 329.63, 392.00, 440.00, 523.25],
            blues: [130.81, 155.56, 174.61, 185.00, 196.00, 233.08, 261.63, 311.13, 349.23, 369.99, 392.00, 466.16, 523.25],
            chromatic: [130.81, 138.59, 146.83, 155.56, 164.81, 174.61, 185.00, 196.00, 207.65, 220.00, 233.08, 246.94, 261.63, 277.18, 293.66, 311.13, 329.63, 349.23, 369.99, 392.00, 415.30, 440.00, 466.16, 493.88, 523.25]
        };

        const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        const noteNamesPT = ['D√≥', 'D√≥#', 'R√©', 'R√©#', 'Mi', 'F√°', 'F√°#', 'Sol', 'Sol#', 'L√°', 'L√°#', 'Si'];

        // Rhythm timing
        const baseBPM = 120;
        let currentBPM = baseBPM;
        let noteInterval = 500; // milliseconds
        let lastNoteTime = 0;
        let currentBeat = 0;
        let beatsInBar = 4;

        // State
        let mouseX = 0;
        let mouseY = 0;
        let depth = 50; // 0-100%
        let currentScale = 'major';
        let currentWaveform = 'sine';
        let isNoteActive = false;

        // Start Audio
        document.getElementById('startButton').addEventListener('click', function() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                isPlaying = true;
                this.textContent = '‚è∏ Stop Audio';
                this.style.background = '#f44336';
            } else {
                isPlaying = !isPlaying;
                if (isPlaying) {
                    this.textContent = '‚è∏ Stop Audio';
                    this.style.background = '#f44336';
                } else {
                    this.textContent = '‚ñ∂ Continue';
                    this.style.background = '#4CAF50';
                }
            }
        });

        // Scale Selection
        document.getElementById('scaleSelect').addEventListener('change', function(e) {
            currentScale = e.target.value;
            document.getElementById('scaleValue').textContent = e.target.options[e.target.selectedIndex].text;
        });

        // Instrument Selection
        document.getElementById('instrumentSelect').addEventListener('change', function(e) {
            currentWaveform = e.target.value;
            // Update index to match manual selection
            currentInstrumentIndex = instruments.findIndex(inst => inst.value === e.target.value);
        });

        // Mouse Tracking
        canvas.addEventListener('mousemove', function(e) {
            const rect = canvas.getBoundingClientRect();
            mouseX = e.clientX - rect.left;
            mouseY = e.clientY - rect.top;
        });

        // Mouse Wheel for Depth (Z-axis) control
        canvas.addEventListener('wheel', function(e) {
            e.preventDefault(); // Prevent page scrolling
            
            // Scroll up increases depth, scroll down decreases
            const delta = e.deltaY > 0 ? -5 : 5;
            depth = Math.max(0, Math.min(100, depth + delta));
        });

        // Keyboard for Depth (Z-axis) and Scale Selection
        const scaleMapping = {
            '1': { value: 'major', text: 'C Major' },
            '2': { value: 'minor', text: 'C Minor' },
            '3': { value: 'pentatonic', text: 'Pentatonic' },
            '4': { value: 'blues', text: 'Blues' },
            '5': { value: 'chromatic', text: 'Chromatic' }
        };

        // Instrument mapping for arrow keys
        const instruments = [
            { value: 'sine', text: 'Synth (Smooth)' },
            { value: 'guitar', text: 'Guitar' },
            { value: 'saxophone', text: 'Saxophone' },
            { value: 'piano', text: 'Piano' }
        ];
        let currentInstrumentIndex = 0;

        function changeInstrument(direction) {
            currentInstrumentIndex += direction;
            
            // Wrap around
            if (currentInstrumentIndex < 0) {
                currentInstrumentIndex = instruments.length - 1;
            } else if (currentInstrumentIndex >= instruments.length) {
                currentInstrumentIndex = 0;
            }
            
            const instrument = instruments[currentInstrumentIndex];
            
            // Update waveform
            currentWaveform = instrument.value;
            
            // Update select dropdown
            document.getElementById('instrumentSelect').value = instrument.value;
            
            // Visual feedback (flash the instrument selector)
            const instrumentSelect = document.getElementById('instrumentSelect');
            instrumentSelect.style.background = '#4CAF50';
            instrumentSelect.style.color = 'white';
            setTimeout(() => {
                instrumentSelect.style.background = 'rgba(255,255,255,0.9)';
                instrumentSelect.style.color = '#222';
            }, 200);
        }

        function updateBPMDisplay() {
            document.getElementById('bpmValue').textContent = currentBPM;
            
            // Update note interval based on BPM
            const beatDuration = (60 / currentBPM) * 1000;
            noteInterval = beatDuration / 4;
        }

        document.addEventListener('keydown', function(e) {
            // Arrow keys for instrument selection (left/right)
            if (e.key === 'ArrowLeft') {
                changeInstrument(-1);
                e.preventDefault();
            } else if (e.key === 'ArrowRight') {
                changeInstrument(1);
                e.preventDefault();
            }
            // Arrow keys for BPM control (up/down)
            else if (e.key === 'ArrowUp') {
                currentBPM = Math.min(200, currentBPM + 5);
                updateBPMDisplay();
                e.preventDefault();
            } else if (e.key === 'ArrowDown') {
                currentBPM = Math.max(40, currentBPM - 5);
                updateBPMDisplay();
                e.preventDefault();
            }
            // Check if key 1-5 is pressed for scale selection
            else if (scaleMapping[e.key]) {
                const scale = scaleMapping[e.key];
                
                // Update scale
                currentScale = scale.value;
                
                // Update select dropdown
                document.getElementById('scaleSelect').value = scale.value;
                
                // Update UI display
                document.getElementById('scaleValue').textContent = scale.text;
                
                // Visual feedback (flash the scale selector)
                const scaleSelect = document.getElementById('scaleSelect');
                scaleSelect.style.background = '#4CAF50';
                scaleSelect.style.color = 'white';
                setTimeout(() => {
                    scaleSelect.style.background = 'rgba(255,255,255,0.9)';
                    scaleSelect.style.color = '#222';
                }, 200);
            }
        });

        // Get closest note in scale
        function getClosestNoteInScale(normalizedX) {
            const scaleNotes = scales[currentScale];
            const index = Math.floor(normalizedX * (scaleNotes.length - 1));
            return scaleNotes[Math.max(0, Math.min(index, scaleNotes.length - 1))];
        }

        // Get note name from frequency
        function getNoteName(frequency) {
            const c0 = 16.35;
            const halfSteps = 12 * Math.log2(frequency / c0);
            const octave = Math.floor(halfSteps / 12);
            const note = Math.round(halfSteps % 12);
            return noteNamesPT[note] + octave;
        }

        // Play a note with envelope (ADSR) - Suporta diferentes instrumentos
        function playNote(frequency, duration, volume) {
            if (!audioContext) return;

            const now = audioContext.currentTime;
            
            // Diferentes configura√ß√µes por instrumento
            if (currentWaveform === 'sine') {
                // Synth - Som puro e suave (sintetizador)
                const osc = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                osc.type = 'sine';
                osc.frequency.value = frequency;
                
                osc.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                const attackTime = 0.02;
                const releaseTime = 0.1;
                const sustainTime = Math.max(0.05, duration - attackTime - releaseTime);
                
                gainNode.gain.setValueAtTime(0, now);
                gainNode.gain.linearRampToValueAtTime(volume * 0.4, now + attackTime);
                gainNode.gain.setValueAtTime(volume * 0.4, now + attackTime + sustainTime);
                gainNode.gain.linearRampToValueAtTime(0, now + attackTime + sustainTime + releaseTime);
                
                osc.start(now);
                osc.stop(now + attackTime + sustainTime + releaseTime);
                
                return { osc, gainNode };
            }
            else if (currentWaveform === 'guitar') {
                // Guitarra - Som mais realista com pluck e harm√¥nicos
                const osc1 = audioContext.createOscillator();
                const osc2 = audioContext.createOscillator();
                const osc3 = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                const gain2 = audioContext.createGain();
                const gain3 = audioContext.createGain();
                const filter = audioContext.createBiquadFilter();
                
                // Fundamental + harm√¥nicos para simular corda
                osc1.type = 'triangle';
                osc1.frequency.value = frequency;
                
                osc2.type = 'triangle';
                osc2.frequency.value = frequency * 2.01; // Ligeiramente desafinado para realismo
                
                osc3.type = 'sawtooth';
                osc3.frequency.value = frequency * 0.5; // Sub-harm√¥nico
                
                // Filtro passa-baixo para simular corpo da guitarra
                filter.type = 'lowpass';
                filter.frequency.value = 3000;
                filter.Q.value = 1;
                
                gain2.gain.value = 0.4;
                gain3.gain.value = 0.2;
                
                osc1.connect(gainNode);
                osc2.connect(gain2);
                osc3.connect(gain3);
                gain2.connect(gainNode);
                gain3.connect(gainNode);
                gainNode.connect(filter);
                filter.connect(audioContext.destination);
                
                // Envelope tipo "pluck" - ataque r√°pido, decay r√°pido, release longo
                const attackTime = 0.003;
                const decayTime = 0.05;
                const releaseTime = 0.8;
                const sustainTime = Math.max(0.05, duration - attackTime - decayTime - releaseTime);
                
                gainNode.gain.setValueAtTime(0, now);
                gainNode.gain.linearRampToValueAtTime(volume * 0.7, now + attackTime);
                gainNode.gain.exponentialRampToValueAtTime(volume * 0.2, now + attackTime + decayTime);
                gainNode.gain.exponentialRampToValueAtTime(volume * 0.15, now + attackTime + decayTime + sustainTime);
                gainNode.gain.exponentialRampToValueAtTime(0.001, now + attackTime + decayTime + sustainTime + releaseTime);
                
                // Modula√ß√£o do filtro para simular "twang"
                filter.frequency.setValueAtTime(5000, now);
                filter.frequency.exponentialRampToValueAtTime(2500, now + 0.05);
                filter.frequency.exponentialRampToValueAtTime(2000, now + 0.2);
                
                osc1.start(now);
                osc2.start(now);
                osc3.start(now);
                osc1.stop(now + attackTime + decayTime + sustainTime + releaseTime);
                osc2.stop(now + attackTime + decayTime + sustainTime + releaseTime);
                osc3.stop(now + attackTime + decayTime + sustainTime + releaseTime);
                
                return { osc: osc1, gainNode };
            }
            else if (currentWaveform === 'saxophone') {
                // Saxofone - Som mais realista com mais harm√¥nicos e vibrato
                const osc1 = audioContext.createOscillator();
                const osc2 = audioContext.createOscillator();
                const osc3 = audioContext.createOscillator();
                const vibrato = audioContext.createOscillator();
                const vibratoGain = audioContext.createGain();
                const gainNode = audioContext.createGain();
                const gain2 = audioContext.createGain();
                const gain3 = audioContext.createGain();
                const filter = audioContext.createBiquadFilter();
                
                // Fundamental + harm√¥nicos √≠mpares (caracter√≠stico de instrumentos de palheta)
                osc1.type = 'sawtooth';
                osc1.frequency.value = frequency;
                
                osc2.type = 'square';
                osc2.frequency.value = frequency * 3; // 3¬∫ harm√¥nico
                
                osc3.type = 'sine';
                osc3.frequency.value = frequency * 5; // 5¬∫ harm√¥nico
                
                // Vibrato mais suave e natural
                vibrato.frequency.value = 4.5;
                vibratoGain.gain.value = 8;
                
                vibrato.connect(vibratoGain);
                vibratoGain.connect(osc1.frequency);
                
                // Filtro para simular timbre de saxofone
                filter.type = 'bandpass';
                filter.frequency.value = 800 + (frequency * 0.8);
                filter.Q.value = 3;
                
                gain2.gain.value = 0.15;
                gain3.gain.value = 0.08;
                
                osc1.connect(filter);
                osc2.connect(gain2);
                osc3.connect(gain3);
                gain2.connect(filter);
                gain3.connect(filter);
                filter.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                // Envelope t√≠pico de sopro - attack gradual, sustain constante
                const attackTime = 0.12;
                const releaseTime = 0.2;
                const sustainTime = Math.max(0.15, duration - attackTime - releaseTime);
                
                gainNode.gain.setValueAtTime(0, now);
                gainNode.gain.linearRampToValueAtTime(volume * 0.15, now + attackTime * 0.3);
                gainNode.gain.linearRampToValueAtTime(volume * 0.45, now + attackTime);
                gainNode.gain.setValueAtTime(volume * 0.45, now + attackTime + sustainTime);
                gainNode.gain.linearRampToValueAtTime(0, now + attackTime + sustainTime + releaseTime);
                
                // Vibrato cresce gradualmente (mais natural)
                vibratoGain.gain.setValueAtTime(0, now);
                vibratoGain.gain.linearRampToValueAtTime(8, now + attackTime + sustainTime * 0.3);
                
                osc1.start(now);
                osc2.start(now);
                osc3.start(now);
                vibrato.start(now);
                osc1.stop(now + attackTime + sustainTime + releaseTime);
                osc2.stop(now + attackTime + sustainTime + releaseTime);
                osc3.stop(now + attackTime + sustainTime + releaseTime);
                vibrato.stop(now + attackTime + sustainTime + releaseTime);
                
                return { osc: osc1, gainNode };
            }
            else if (currentWaveform === 'piano') {
                // Piano - M√∫ltiplas ondas (fundamental + harm√≥nicos)
                const osc1 = audioContext.createOscillator();
                const osc2 = audioContext.createOscillator();
                const osc3 = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                const gain2 = audioContext.createGain();
                const gain3 = audioContext.createGain();
                
                osc1.type = 'sine';
                osc1.frequency.value = frequency;
                
                osc2.type = 'sine';
                osc2.frequency.value = frequency * 2;
                
                osc3.type = 'sine';
                osc3.frequency.value = frequency * 3;
                
                gain2.gain.value = 0.3;
                gain3.gain.value = 0.15;
                
                osc1.connect(gainNode);
                osc2.connect(gain2);
                osc3.connect(gain3);
                gain2.connect(gainNode);
                gain3.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                const attackTime = 0.005;
                const decayTime = 0.1;
                const releaseTime = 0.4;
                const sustainTime = Math.max(0.05, duration - attackTime - decayTime - releaseTime);
                
                gainNode.gain.setValueAtTime(0, now);
                gainNode.gain.linearRampToValueAtTime(volume * 0.6, now + attackTime);
                gainNode.gain.exponentialRampToValueAtTime(volume * 0.3, now + attackTime + decayTime);
                gainNode.gain.setValueAtTime(volume * 0.3, now + attackTime + decayTime + sustainTime);
                gainNode.gain.exponentialRampToValueAtTime(0.001, now + attackTime + decayTime + sustainTime + releaseTime);
                
                osc1.start(now);
                osc2.start(now);
                osc3.start(now);
                osc1.stop(now + attackTime + decayTime + sustainTime + releaseTime);
                osc2.stop(now + attackTime + decayTime + sustainTime + releaseTime);
                osc3.stop(now + attackTime + decayTime + sustainTime + releaseTime);
                
                return { osc: osc1, gainNode };
            }
        }

        // Update beat indicators
        function updateBeatIndicators() {
            const dots = document.querySelectorAll('.beat-dot');
            dots.forEach((dot, i) => {
                if (i === currentBeat) {
                    dot.classList.add('active');
                } else {
                    dot.classList.remove('active');
                }
            });
        }

        // Animation Loop
        function animate(timestamp) {
            // Clear canvas
            ctx.fillStyle = 'rgba(168, 230, 207, 0.3)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            if (canvas.width > 0) {
                // Calculate parameters
                const normalizedX = mouseX / canvas.width;
                const normalizedY = 1 - (mouseY / canvas.height);
                
                // Eixo X: Pitch
                targetFrequency = getClosestNoteInScale(normalizedX);
                currentFrequency = targetFrequency;
                
                // Eixo Y: Rhythm subdivision
                // Map Y to note divisions: 1/16, 1/8, 1/4, 1/2, 1
                const subdivisions = [16, 12, 8, 6, 4, 3, 2, 1];
                const subdivIndex = Math.floor(normalizedY * subdivisions.length);
                const currentSubdiv = subdivisions[Math.min(subdivIndex, subdivisions.length - 1)];
                
                // Calculate note interval based on subdivision
                const beatDuration = (60 / currentBPM) * 1000; // milliseconds per beat
                noteInterval = beatDuration / (currentSubdiv / 4);
                
                // Update rhythm display
                document.getElementById('rhythmValue').textContent = '1/' + currentSubdiv;
                document.getElementById('rhythmText').textContent = '1/' + currentSubdiv;
                
                // Eixo Z: Volume
                const volume = depth / 100;
                
                // Trigger notes based on rhythm
                if (isPlaying && timestamp - lastNoteTime >= noteInterval) {
                    playNote(currentFrequency, noteInterval / 1000, volume);
                    lastNoteTime = timestamp;
                    currentBeat = (currentBeat + 1) % beatsInBar;
                    updateBeatIndicators();
                    isNoteActive = true;
                    
                    // Reset note active flag after short time
                    setTimeout(() => { isNoteActive = false; }, 100);
                }
                
                // Update UI
                document.getElementById('xValue').textContent = Math.round(normalizedX * 100) + '%';
                document.getElementById('yValue').textContent = Math.round(normalizedY * 100) + '%';
                document.getElementById('zValue').textContent = Math.round(depth) + '%';
                document.getElementById('noteValue').textContent = getNoteName(currentFrequency);
                document.getElementById('volumeValue').textContent = Math.round(volume * 100) + '%';
                document.getElementById('bpmValue').textContent = currentBPM;
                
                // Visual feedback - circle size based on volume
                const circleSize = isNoteActive ? (50 + (volume * 200)) : (30 + (volume * 100));
                const circleOpacity = isNoteActive ? (volume * 0.5) : (volume * 0.2);
                
                ctx.beginPath();
                ctx.arc(mouseX, mouseY, circleSize, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(255, 255, 255, ${circleOpacity})`;
                ctx.fill();
                
                // Inner circle
                if (isNoteActive) {
                    ctx.beginPath();
                    ctx.arc(mouseX, mouseY, circleSize * 0.5, 0, Math.PI * 2);
                    ctx.fillStyle = `rgba(76, 175, 80, ${volume * 0.7})`;
                    ctx.fill();
                }
                
                // Note label
                ctx.fillStyle = isNoteActive ? '#4CAF50' : 'white';
                ctx.font = isNoteActive ? 'bold 28px monospace' : 'bold 20px monospace';
                ctx.textAlign = 'center';
                ctx.fillText(getNoteName(currentFrequency), mouseX, mouseY + 8);
            }
            
            requestAnimationFrame(animate);
        }

        animate(0);
    </script>
</body>
</html>
